-- Load the required Roblox services 
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local DataStoreService = game:GetService("DataStoreService")
-- Define remote events and other variables
local RemoteEvents = ReplicatedStorage:FindFirstChild("RemoteEvents")
local TrailEvent = RemoteEvents:WaitForChild("TrailEvent")
-- Data store for player data
local PlayerData = DataStoreService:GetDataStore("PlayerData")
-- Gamepass IDs
local GamePassIDs = {
	Vip = 852237365,
	Carpet = 852336194,
	Hook = 852371019,
	TrippleJump = 852332151,
	DoubleJump = 852201556,
	FusionCoil = 852431056,
	GravityCoil = 852308346,
	SpeedCoil = 852413116,
	Unicorn = 852317290,
	Balloon = 852204569,
	Cat = 852108968,
	RainbowTrail = 852347457,
	FlameTrail = 852402377,
	RedTrail = 852329560,
	PurpleTrail = 852432319,
	BlueTrail = 852464229,
	YellowTrail = 852233807,
	GreenTrail = 852381447,
	WhiteTrail = 852291565
}
-- Function to give a tool to a player
local function giveTool(player, toolName)
	local toolClone = ReplicatedStorage.Tools:FindFirstChild(toolName):Clone()
	toolClone.Parent = player.Backpack
	if toolClone.Name == "SpeedCoil" or toolClone.Name == "FusionCoil" then
		local new = Instance.new("IntValue", toolClone)
		new.Name = "Speed"
		new.Value = player:GetAttribute("WalkSpeed")
	end
end
-- Function to handle game pass purchases
local function handleGamePass(player, gamePassID, callback)
	local retries = 3
	local success, ownsPass
	for i = 1, retries do
		success, ownsPass = pcall(function()
			return MarketplaceService:UserOwnsGamePassAsync(player.UserId, gamePassID)
		end)
		if success then
			break
		else
			warn("Retrying game pass check... Attempt " .. i)
			task.wait(1)
		end
	end
	if success and ownsPass then
		callback()
	elseif not success then
		warn("Error checking game pass ownership after " .. retries .. " attempts: " .. tostring(ownsPass))
	end
end
-- Function to handle game pass purchase finished event
local function onPromptPurchaseFinished(player, purchasedPassID, purchaseSuccess)
	if not purchaseSuccess then return end
	local gamePassActions = {
		[GamePassIDs.Vip] = function()
			player:SetAttribute("VIP", true)
			giveTool(player, "FusionCoil")
			player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 2)
		end,
		[GamePassIDs.TrippleJump] = function()
			player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 3)
		end,
		[GamePassIDs.DoubleJump] = function()
			player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 2)
		end,
		[GamePassIDs.Carpet] = function()
			giveTool(player, "MagicCarpet")
		end,
		[GamePassIDs.Hook] = function()
			giveTool(player, "Hook")
		end,
		[GamePassIDs.FusionCoil] = function()
			giveTool(player, "FusionCoil")
		end,
		[GamePassIDs.GravityCoil] = function()
			giveTool(player, "GravityCoil")
		end,
		[GamePassIDs.SpeedCoil] = function()
			giveTool(player, "SpeedCoil")
		end,
		[GamePassIDs.Unicorn] = function()
			giveTool(player, "Unicorn")
		end,
		[GamePassIDs.Balloon] = function()
			giveTool(player, "Balloon")
		end,
		[GamePassIDs.Cat] = function()
			giveTool(player, "Cat")
		end,
		[GamePassIDs.RainbowTrail] = function()
			CreateTrail(player, "RainbowTrail")
		end,
		[GamePassIDs.FlameTrail] = function()
			CreateTrail(player, "FlameTrail")
		end,
		[GamePassIDs.RedTrail] = function()
			CreateTrail(player, "RedTrail")
		end,
		[GamePassIDs.PurpleTrail] = function()
			CreateTrail(player, "PurpleTrail")
		end,
		[GamePassIDs.BlueTrail] = function()
			CreateTrail(player, "BlueTrail")
		end,
		[GamePassIDs.YellowTrail] = function()
			CreateTrail(player, "YellowTrail")
		end,
		[GamePassIDs.GreenTrail] = function()
			CreateTrail(player, "GreenTrail")
		end,
		[GamePassIDs.WhiteTrail] = function()
			CreateTrail(player, "WhiteTrail")
		end
	}
	if gamePassActions[purchasedPassID] then
		gamePassActions[purchasedPassID]()
	end
end
-- Connect the game pass purchase finished event
MarketplaceService.PromptGamePassPurchaseFinished:Connect(onPromptPurchaseFinished)
-- Function to create a trail for the player
function CreateTrail(player, TrailName)
	local playerTrails = player.Character:FindFirstChild("Trails") or Instance.new("Folder", player.Character)
	playerTrails.Name = "Trails"
	task.wait(0.1)
	if playerTrails:FindFirstChild(TrailName) then
		playerTrails:ClearAllChildren()
	else
		playerTrails:ClearAllChildren()
		task.wait(0.01)
		local TrailsFolder = ReplicatedStorage:WaitForChild("TrailsFolder")
		local Trails = TrailsFolder:FindFirstChild(TrailName)
		if not Trails then
			return
		end
		local part1 = Trails.Part1:Clone()
		local part2 = Trails.Part2:Clone()
		local weld1 = Trails.weld1:Clone()
		local weld2 = Trails.weld2:Clone()
		part1.Parent = playerTrails
		part2.Parent = playerTrails
		weld1.Parent = playerTrails
		weld1.Part0 = player.Character.HumanoidRootPart
		weld1.Part1 = part1
		weld2.Parent = playerTrails
		weld2.Part0 = player.Character.HumanoidRootPart
		weld2.Part1 = part2
		part1.Position = player.Character.HumanoidRootPart.Position + Vector3.new(0, 0.7, 0)
		part2.Position = player.Character.HumanoidRootPart.Position - Vector3.new(0, 0.7, 0)
		local newTrail = Trails:FindFirstChildWhichIsA("Trail"):Clone()
		newTrail.Attachment0 = part1.Attachment
		newTrail.Attachment1 = part2.Attachment
		newTrail.Parent = playerTrails
		player:SetAttribute("Trail", newTrail.Name)
	end
end
-- Connect the trail event
TrailEvent.OnServerEvent:Connect(function(player, trailName)
	if player then
		CreateTrail(player, trailName)
	end
end)
-- Function to handle player added event
local function handleGamePasses(player)
	local passes = {
		{GamePassIDs.Vip, function() player:SetAttribute("VIP", true) giveTool(player, "FusionCoil") player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 2) end},
		{GamePassIDs.TrippleJump, function() player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 3) end},
		{GamePassIDs.DoubleJump, function() player:SetAttribute("Jumps", (player:GetAttribute("Jumps") or 0) + 2) end},
		{GamePassIDs.Carpet, function() giveTool(player, "MagicCarpet") end},
		{GamePassIDs.Hook, function() giveTool(player, "Hook") end},
		{GamePassIDs.FusionCoil, function() giveTool(player, "FusionCoil") end},
		{GamePassIDs.GravityCoil, function() giveTool(player, "GravityCoil") end},
		{GamePassIDs.SpeedCoil, function() giveTool(player, "SpeedCoil") end},
		{GamePassIDs.Unicorn, function() giveTool(player, "Unicorn") end},
		{GamePassIDs.Balloon, function() giveTool(player, "Balloon") end},
		{GamePassIDs.Cat, function() giveTool(player, "Cat") end},
		{GamePassIDs.RainbowTrail, function() CreateTrail(player, "RainbowTrail") end},
		{GamePassIDs.FlameTrail, function() CreateTrail(player, "FlameTrail") end},
		{GamePassIDs.RedTrail, function() CreateTrail(player, "RedTrail") end},
		{GamePassIDs.PurpleTrail, function() CreateTrail(player, "PurpleTrail") end},
		{GamePassIDs.BlueTrail, function() CreateTrail(player, "BlueTrail") end},
		{GamePassIDs.YellowTrail, function() CreateTrail(player, "YellowTrail") end},
		{GamePassIDs.GreenTrail, function() CreateTrail(player, "GreenTrail") end},
		{GamePassIDs.WhiteTrail, function() CreateTrail(player, "WhiteTrail") end}
	}
	for _, pass in ipairs(passes) do
		handleGamePass(player, pass[1], pass[2])
	end
end
-- Connect the player added event
Players.PlayerAdded:Connect(handleGamePasses)
